/**
 * @file Firestore Security Rules
 * @core_philosophy This ruleset enforces a strict user-ownership model for data access.
 *   Each user can only read and write data they own, based on the `ownerId` field in documents.
 * @data_structure Data is organized into top-level collections for projects, tasks, invoices, expenses, and contacts.
 *   User profiles are stored under `/users/{userId}`.
 * @key_security_decisions
 *   - User listing is disallowed.
 *   - Data schema is not strictly enforced, focusing on authorization.
 *   - Each data entity has an ownerId and can only be accessed by that owner
 * @denormalization_for_authorization
 *   - Documents contain `ownerId`, which is used to make authorization decisions.
 * @structural_segregation No structural segregation is used in this ruleset.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile information.
     * @path /users/{userId}
     * @allow (create) - Authenticated user can create their own profile if the UID matches the document ID.
     * @allow (get, list, update, delete) - Authenticated user can only access their own profile.
     * @deny (create) - If the UID does not match the document ID.
     * @deny (update, delete) - If the user is not the owner.
     * @principle Enforces user ownership for profile data.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner() {
          return isSignedIn() && resource.data.ownerId == request.auth.uid;
      }
      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isExistingOwner();
      allow delete: if isSignedIn() && isExistingOwner();
    }

    /**
     * @description Controls access to project data.
     * @path /projects/{projectId}
     * @allow (get, list) - Public read access.
     * @allow (create) - Only the authenticated user can create a project, ownerId must match their uid.
     * @allow (update, delete) - Only the owner can update or delete a project.
     * @deny (create) - If the ownerId does not match the user's UID.
     * @deny (update, delete) - If the user is not the owner.
     * @principle Enforces owner-only writes with public reads for projects.
     */
    match /projects/{projectId} {
        function isSignedIn() {
            return request.auth != null;
        }

        function isOwner() {
            return request.auth.uid == resource.data.ownerId;
        }

        function isExistingOwner() {
            return isSignedIn() && resource.data.ownerId == request.auth.uid;
        }

        allow get, list: if true;
        allow create: if isSignedIn() && isOwner();
        allow update: if isSignedIn() && isExistingOwner();
        allow delete: if isSignedIn() && isExistingOwner();
    }

    /**
     * @description Controls access to task data.
     * @path /tasks/{taskId}
     * @allow (get, list) - Public read access.
     * @allow (create) - Only the authenticated user can create a task, ownerId must match their uid.
     * @allow (update, delete) - Only the owner can update or delete a task.
     * @deny (create) - If the ownerId does not match the user's UID.
     * @deny (update, delete) - If the user is not the owner.
     * @principle Enforces owner-only writes with public reads for tasks.
     */
    match /tasks/{taskId} {
        function isSignedIn() {
            return request.auth != null;
        }

        function isOwner() {
            return request.auth.uid == request.resource.data.ownerId;
        }

        function isExistingOwner() {
            return isSignedIn() && resource.data.ownerId == request.auth.uid;
        }

        allow get, list: if true;
        allow create: if isSignedIn() && isOwner();
        allow update: if isSignedIn() && isExistingOwner();
        allow delete: if isSignedIn() && isExistingOwner();
    }

    /**
     * @description Controls access to invoices data.
     * @path /invoices/{invoiceId}
     * @allow (get, list) - Public read access.
     * @allow (create) - Only the authenticated user can create a invoice, ownerId must match their uid.
     * @allow (update, delete) - Only the owner can update or delete a invoice.
     * @deny (create) - If the ownerId does not match the user's UID.
     * @deny (update, delete) - If the user is not the owner.
     * @principle Enforces owner-only writes with public reads for invoices.
     */
    match /invoices/{invoiceId} {
        function isSignedIn() {
            return request.auth != null;
        }

        function isOwner() {
            return request.auth.uid == request.resource.data.ownerId;
        }

        function isExistingOwner() {
            return isSignedIn() && resource.data.ownerId == request.auth.uid;
        }

        allow get, list: if true;
        allow create: if isSignedIn() && isOwner();
        allow update: if isSignedIn() && isExistingOwner();
        allow delete: if isSignedIn() && isExistingOwner();
    }

    /**
     * @description Controls access to expenses data.
     * @path /expenses/{expenseId}
     * @allow (get, list) - Public read access.
     * @allow (create) - Only the authenticated user can create a expense, ownerId must match their uid.
     * @allow (update, delete) - Only the owner can update or delete a expense.
     * @deny (create) - If the ownerId does not match the user's UID.
     * @deny (update, delete) - If the user is not the owner.
     * @principle Enforces owner-only writes with public reads for expenses.
     */
    match /expenses/{expenseId} {
        function isSignedIn() {
            return request.auth != null;
        }

        function isOwner() {
            return request.auth.uid == request.resource.data.ownerId;
        }

        function isExistingOwner() {
            return isSignedIn() && resource.data.ownerId == request.auth.uid;
        }

        allow get, list: if true;
        allow create: if isSignedIn() && isOwner();
        allow update: if isSignedIn() && isExistingOwner();
        allow delete: if isSignedIn() && isExistingOwner();
    }

      /**
       * @description Controls access to contacts data.
       * @path /contacts/{contactId}
       * @allow (get, list) - Public read access.
       * @allow (create) - Only the authenticated user can create a contact, ownerId must match their uid.
       * @allow (update, delete) - Only the owner can update or delete a contact.
       * @deny (create) - If the ownerId does not match the user's UID.
       * @deny (update, delete) - If the user is not the owner.
       * @principle Enforces owner-only writes with public reads for contacts.
       */
      match /contacts/{contactId} {
          function isSignedIn() {
              return request.auth != null;
          }

          function isOwner() {
              return request.auth.uid == request.resource.data.ownerId;
          }

          function isExistingOwner() {
              return isSignedIn() && resource.data.ownerId == request.auth.uid;
          }

          allow get, list: if true;
          allow create: if isSignedIn() && isOwner();
          allow update: if isSignedIn() && isExistingOwner();
          allow delete: if isSignedIn() && isExistingOwner();
      }
  }
}