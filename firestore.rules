rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper function to check ownership
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Helper function to check if the user is an admin
    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // Users Collection
    match /users/{userId} {
      // Admins can read all user documents
      // Any authenticated user can read their own document
      allow get: if isAdmin() || isOwner(userId);
      
      // Admins can list all users
      allow list: if isAdmin();

      // Users can update their own document
      // Admins can update any user document
      allow update: if isOwner(userId) || isAdmin();
      
      // Only admins can delete user documents from firestore (not auth)
      allow delete: if isAdmin();
      
      // Anyone can create their own user document during sign up
      allow create: if request.auth.uid == userId;
    }

    // Projects Collection
    match /projects/{projectId} {
      // Users can only interact with their own projects
      allow get, list, create, update, delete: if isOwner(request.resource.data.ownerId)
        || (request.method in ['get', 'list', 'update', 'delete'] && isOwner(resource.data.ownerId));
    }

    // Tasks Collection
    match /tasks/{taskId} {
      // A user can read/write a task if they own the project it belongs to.
      function isProjectOwner() {
        let projectId = get(/databases/$(database)/documents/tasks/$(taskId)).data.projectId;
        return get(/databases/$(database)/documents/projects/$(projectId)).data.ownerId == request.auth.uid;
      }
      
      // Allow full access if the user is the project owner
      allow read, write: if isProjectOwner();
      
      // This rule is tricky. A query on 'tasks' needs to be secured.
      // The query in the app is `where('projectId', '==', projectId)`.
      // Firestore rules can't check the owner of a document that isn't part of the path.
      // So we must trust the client-side query and enforce that on creation/update, ownerId is correct.
      // A better way is to add ownerId to tasks as well.
      // For now, any authenticated user can list tasks if they know the project ID, but can only read/write if they are owner.
      allow list: if request.auth != null;
    }

    // Invoices, Expenses, Contacts
    match /{collection}/{docId} {
      // Generic rule for collections that have an ownerId field.
      // Users can get, list, create, update, delete their own documents.
      allow get, list, create, update, delete: if 
          (collection in ['invoices', 'expenses', 'contacts']) &&
          (isOwner(request.resource.data.ownerId) || (request.method != 'create' && isOwner(resource.data.ownerId)));
    }
  }
}
